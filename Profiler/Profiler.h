#pragma once

#include <string>
#include <map>
#define _WINSOCKAPI_
#include <Windows.h>
#undef _WINSOCKAPI_

class Profiler
{
private:
    struct ProfileSample;
public:
    Profiler();
    ~Profiler();
    void BeginRecord(const wchar_t* szTag);
    inline void EndRecord(const wchar_t* szTag);
    void SaveProfileToFile(const wchar_t* szFileName);
private:
    void RecordEndRequestHandler(const wchar_t* szTag, LARGE_INTEGER endTime);
    std::map<std::wstring, ProfileSample*> _DataMap;
    LONGLONG _Frequency;
    static const wchar_t* szLine;
    static const wchar_t* szItems;
private:
    struct ProfileSample
    {
        friend Profiler;
    public:
        ProfileSample(std::wstring tag);
    private:
        std::wstring tag; // 프로파일 샘플 이름
        ULONGLONG lastStartTime; // 프로파일 샘플 실행 시간.
        ULONGLONG totalTime; // 전체 사용시간 카운터 Time. (출력시 호출회수로 나누어 평균 구함)
        ULONGLONG minimumTime; // 최소 사용시간 카운터 Time. (초단위로 계산하여 저장 / [0] 가장최소 [1] 다음 최소 [2])
        ULONGLONG maximumTime; // 최대 사용시간 카운터 Time. (초단위로 계산하여 저장 / [0] 가장최대 [1] 다음 최대 [2])
        int numOfCalls; // 누적 호출 횟수
    };
};

inline void Profiler::EndRecord(const wchar_t* szTag)
{
    LARGE_INTEGER endTime;
    QueryPerformanceCounter(&endTime);

    RecordEndRequestHandler(szTag, endTime);
}
